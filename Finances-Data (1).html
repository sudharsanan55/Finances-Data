<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>User Plan & Daily Collection Report</title>

<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{--accent:#007bff;--muted:#6b7280}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#f5f6fa;color:#222}
  .container{max-width:980px;margin:28px auto;padding:0 18px}
  h1{font-size:22px;text-align:center;margin-bottom:18px}
  .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,45,0.06);padding:18px;margin-bottom:22px;border:1px solid rgba(0,0,0,0.03)}
  .card h2{margin:0 0 12px;font-size:18px;color:#111;padding-left:6px;border-left:4px solid var(--accent)}
  .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .form-grid .full{grid-column:1/-1}
  label{display:block;font-size:13px;color:#0f172a;margin-bottom:6px;font-weight:600}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;font-size:14px;box-sizing:border-box}
  textarea{min-height:70px;resize:vertical}
  .primary{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
  .primary:hover{filter:brightness(.95)}
  .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  button.ghost{background:#fff;border:1px solid #e5e7eb;padding:8px 12px;border-radius:8px;cursor:pointer}
  .table-wrap{margin-top:12px;overflow:auto;border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:14px;background:#fff}
  thead th{background:var(--accent);color:#fff;padding:10px;text-align:center;font-weight:700}
  tbody td, tfoot td{padding:12px;text-align:center;border:1px solid #edf2f7}
  tbody tr:nth-child(even){background:#fbfdff}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .pill.yes{background:#e6ffef;color:#0b6b2f}
  .pill.no{background:#fff0f0;color:#a00}
  .empty{color:#6b7280;padding:14px;text-align:center}
  tfoot td{background:#fafafa;font-weight:700}
  @media (max-width:720px){
    .form-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="container">
    <h1>📊 User Plan & Daily Collection Report</h1>

    <!-- User Plan Tracker -->
    <section class="card">
      <h2>User Plan Tracker</h2>
      <form id="userForm" class="form-grid" autocomplete="off">
        <div>
          <label>User Number</label>
          <input id="userNumber" type="text" required placeholder="e.g. 101">
        </div>
        <div>
          <label>Name</label>
          <input id="userName" type="text" required placeholder="Full name">
        </div>
        <div class="full">
          <label>Address</label>
          <textarea id="userAddress" placeholder="Optional"></textarea>
        </div>
        <div>
          <label>Phone No</label>
          <input id="userPhone" type="text" placeholder="Phone">
        </div>
        <div>
          <label>Amount</label>
          <input id="userAmount" type="number" min="0" step="0.01" placeholder="0.00">
        </div>
        <div>
          <label>Starting Date</label>
          <input id="userStart" type="date">
        </div>
        <div>
          <label>Plan (days)</label>
          <select id="userPlan">
            <option value="">-- Select Plan --</option>
            <option value="100">100 Days</option>
            <option value="60">60 Days</option>
            <option value="30">30 Days</option>
          </select>
        </div>
        <div>
          <label>Ending Date (Auto)</label>
          <input id="userEnd" type="date" readonly>
        </div>
        <div class="full">
          <button type="submit" class="primary">➕ Add User</button>
          <div style="display:inline-block;width:8px"></div>
          <button type="button" id="exportUsers" class="ghost">⬇ Export Users</button>
        </div>
      </form>
      <div class="table-wrap">
        <table id="usersTable">
          <thead>
            <tr>
              <th>User Number</th><th>Name</th><th>Address</th><th>Phone</th>
              <th>Amount</th><th>Start Date</th><th>Plan</th><th>End Date</th>
            </tr>
          </thead>
          <tbody id="usersTbody"><tr><td colspan="8" class="empty">No users yet.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Daily Collection -->
    <section class="card">
      <h2>Daily Collection Report</h2>
      <form id="entryForm" class="form-grid" autocomplete="off">
        <div>
          <label>Date</label>
          <input id="entryDate" type="date">
        </div>
        <div>
          <label>Number</label>
          <input id="entryNumber" type="text" placeholder="Enter user number">
          <span id="entryNumberWarning" style="color:red; display:none; font-size:12px; margin-left:5px;">
            Number already exists for today!
          </span>
        </div>
        <div>
          <label>Name (auto)</label>
          <input id="entryName" type="text" readonly placeholder="Will auto-fill if found">
        </div>
        <div>
          <label>Amount</label>
          <input id="entryAmount" type="number" min="0" step="0.01" placeholder="0.00">
        </div>
        <div>
          <label>G Pay</label>
          <select id="entryGpay">
            <option value="">Select…</option>
            <option>Yes</option>
            <option>No</option>
          </select>
        </div>
        <div class="full">
          <button type="submit" class="primary">➕ Add Entry</button>
          <div style="display:inline-block;width:8px"></div>
          <button type="button" id="exportCSV" class="ghost">Export CSV</button>
          <button type="button" id="exportXLSX" class="ghost">Export Excel</button>
          <button type="button" id="printBtn" class="ghost">Print</button>
        </div>
      </form>
      <div class="table-wrap">
        <table id="entriesTable">
          <thead>
            <tr><th>#</th><th>Date</th><th>Number</th><th>Name</th><th>Amount</th><th>G Pay</th><th>Actions</th></tr>
          </thead>
          <tbody id="entriesTbody"><tr><td colspan="7" class="empty">No entries yet.</td></tr></tbody>
          <tfoot><tr><td colspan="4">Total</td><td id="entriesTotal">0.00</td><td colspan="2"></td></tr></tfoot>
        </table>
      </div>
    </section>
  </div>

<script>
(function () {
  const userKey = 'fin_userPlans_v1';
  const entryKey = 'fin_daily_v1';

  const $ = sel => document.querySelector(sel);
  const todayStr = ()=>{
    const d=new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  };
  const escapeHtml = s => String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));

  let users = JSON.parse(localStorage.getItem(userKey) || '[]');
  let entries = JSON.parse(localStorage.getItem(entryKey) || '[]');

  const usersTbody = $('#usersTbody');
  const entriesTbody = $('#entriesTbody');
  const entriesTotal = $('#entriesTotal');

  $('#entryDate').value = todayStr();

  // ---------- Users ----------
  function saveUsers(){ localStorage.setItem(userKey, JSON.stringify(users)); }
  function renderUsers(){
    usersTbody.innerHTML = '';
    if(!users.length){ usersTbody.innerHTML = '<tr><td colspan="8" class="empty">No users yet.</td></tr>'; return; }
    users.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(u.number)}</td>
        <td style="text-align:left;padding-left:12px">${escapeHtml(u.name)}</td>
        <td style="text-align:left;padding-left:12px">${escapeHtml(u.address)}</td>
        <td>${escapeHtml(u.phone)}</td>
        <td>${Number(u.amount||0).toFixed(2)}</td>
        <td>${escapeHtml(u.startDate||'')}</td>
        <td>${escapeHtml((u.plan||'') + (u.plan ? ' Days' : ''))}</td>
        <td>${escapeHtml(u.endDate||'')}</td>
      `;
      usersTbody.appendChild(tr);
    });
  }

  function calcEndDateValue(start, planDays){
    if(!start || !planDays) return '';
    const d = new Date(start);
    d.setDate(d.getDate() + Number(planDays));
    return d.toISOString().slice(0,10);
  }
  $('#userStart').addEventListener('change', ()=> {
    $('#userEnd').value = calcEndDateValue($('#userStart').value, $('#userPlan').value);
  });
  $('#userPlan').addEventListener('change', ()=> {
    $('#userEnd').value = calcEndDateValue($('#userStart').value, $('#userPlan').value);
  });

  $('#userForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const number = $('#userNumber').value.trim();
    const name = $('#userName').value.trim();
    if(!number || !name){ alert('Please enter User Number and Name'); return; }
    if(users.some(u=>u.number === number)){
      if(!confirm('User number already exists. Add duplicate?')) return;
    }
    const userObj = {
      number,
      name,
      address: $('#userAddress').value.trim(),
      phone: $('#userPhone').value.trim(),
      amount: $('#userAmount').value ? Number($('#userAmount').value).toFixed(2) : '0.00',
      startDate: $('#userStart').value || '',
      plan: $('#userPlan').value || '',
      endDate: $('#userEnd').value || ''
    };
    users.push(userObj);
    saveUsers();
    renderUsers();
    e.target.reset();
    $('#userEnd').value = '';
  });

  $('#exportUsers').addEventListener('click', ()=>{
    if(typeof XLSX !== 'undefined'){
      const data = users.map(u => ({Number: u.number, Name: u.name, Address: u.address, Phone: u.phone, Amount: u.amount, 'Start Date': u.startDate, Plan: u.plan, 'End Date': u.endDate}));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Users');
      XLSX.writeFile(wb, `users-${todayStr()}.xlsx`);
    } else {
      const rows = [['Number','Name','Address','Phone','Amount','Start Date','Plan','End Date'], ...users.map(u=>[u.number,u.name,u.address,u.phone,u.amount,u.startDate,u.plan,u.endDate])];
      const csv = rows.map(r => r.map(v => (''+v).includes(',')?`"${(''+v).replace(/"/g,'""')}"` : v).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `users-${todayStr()}.csv`; a.click();
    }
  });

  // ---------- Entries ----------
  function saveEntries(){ localStorage.setItem(entryKey, JSON.stringify(entries)); }
  function renderEntries(){
    entriesTbody.innerHTML = '';
    if(!entries.length){ entriesTbody.innerHTML = '<tr><td colspan="7" class="empty">No entries yet.</td></tr>'; entriesTotal.textContent = '0.00'; return; }
    let total = 0;
    entries.forEach((en, idx)=>{
      total += Number(en.amount||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHtml(en.date)}</td>
        <td>${escapeHtml(en.number)}</td>
        <td style="text-align:left;padding-left:12px">${escapeHtml(en.name||'')}</td>
        <td>${Number(en.amount||0).toFixed(2)}</td>
        <td>${en.gpay === 'Yes' ? '<span class="pill yes">Yes</span>' : '<span class="pill no">No</span>'}</td>
        <td><button class="ghost" onclick="deleteEntry('${en.id}')">🗑️</button></td>
      `;
      entriesTbody.appendChild(tr);
    });
    entriesTotal.textContent = total.toFixed(2);
  }

  window.deleteEntry = function(id){
    if(!confirm('Delete this entry?')) return;
    entries = entries.filter(e => e.id !== id);
    saveEntries();
    renderEntries();
  };

  // auto fill + duplicate check while typing
  $('#entryNumber').addEventListener('input', (ev)=>{
    const n = ev.target.value.trim();
    const found = users.find(u => String(u.number) === String(n));
    $('#entryName').value = found ? found.name : '';
    const today = $('#entryDate').value || todayStr();
    const duplicate = entries.some(e => e.number === n && e.date === today);
    $('#entryNumberWarning').style.display = duplicate ? 'inline' : 'none';
  });

  // add entry
  $('#entryForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const date = $('#entryDate').value || todayStr();
    const number = $('#entryNumber').value.trim();
    if(!number){ alert('Please enter Number'); return; }
    if(entries.some(en => en.number === number && en.date === date)){
      alert('This number already exists for today!');
      return;
    }
    const amount = parseFloat($('#entryAmount').value || '0');
    const name = $('#entryName').value.trim();
    const gpay = $('#entryGpay').value || '';
    const entryObj = { id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2), date, number, name, amount, gpay };
    entries.push(entryObj);
    saveEntries();
    renderEntries();
    e.target.reset();
    $('#entryDate').value = todayStr();
    $('#entryNumberWarning').style.display = 'none';
  });

  $('#exportCSV').addEventListener('click', ()=>{
    if(!entries.length){ alert('No entries to export'); return; }
    const rows = [['Date','Number','Name','Amount','G Pay'], ...entries.map(e=>[e.date,e.number,e.name,Number(e.amount||0).toFixed(2),e.gpay])];
    const csv = rows.map(r => r.map(v => (''+v).includes(',')?`"${(''+v).replace(/"/g,'""')}"` : v).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `daily-collection-${todayStr()}.csv`; a.click();
  });

  $('#exportXLSX').addEventListener('click', ()=>{
    if(!entries.length){ alert('No entries to export'); return; }
    if(typeof XLSX === 'undefined'){ alert('Excel export requires the SheetJS library.'); return; }
    const data = entries.map(e => ({Date:e.date, Number:e.number, Name:e.name, Amount:Number(e.amount||0).toFixed(2), 'G Pay': e.gpay}));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Collection');
    XLSX.writeFile(wb, `daily-collection-${todayStr()}.xlsx`);
  });

  $('#printBtn').addEventListener('click', ()=> window.print());

  renderUsers();
  renderEntries();
})();
</script>
</body>
</html>
